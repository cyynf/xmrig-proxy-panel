<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ProxyPanel</title>
    <meta content="width=1000, initial-scale=0.5, maximum-scale=1, user-scalable=yes" name="viewport">
    <link rel="icon" href="img/favicon.png" type="image/x-icon"/>
    <link rel="stylesheet" href="modules/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="modules/Ionicons/css/ionicons.min.css">
    <link rel="stylesheet" href="modules/datatables.net-bs/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="css/AdminLTE.min.css">
    <link rel="stylesheet" href="css/skin-black.min.css">
    <style>
        .info-box-content {
            text-align: center;
            height: 30px;
            line-height: 30px;
            padding-top: 10px;
        }

        .info-box-text {
            text-transform: none;
        }

        .table-right {
            text-align: right;
        }

        .table-center {
            text-align: center;
        }
    </style>
</head>
<body class="hold-transition skin-black layout-top-nav">
<div class="wrapper">
    <header class="main-header">
        <nav class="navbar-default navbar-static-top navbar-light bg-faded">
            <div class="container">
                <div class="navbar-header">
                    <a href="" class="navbar-brand"><b>Proxy</b>Panel</a>
                </div>

                <div class="navbar-default pull-right">
                    <ul class="nav navbar-nav">
                        <li><span id="best" class="navbar-text"></span></li>
                        <li><span id="latency" class="navbar-text"></span></li>
                        <li><span id="avg_time" class="navbar-text"></span></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="content-wrapper">
        <div class="container">
            <section class="content">
                <div class="row">
                    <div id="main">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-green"><i
                                            class="ion ion-ios-world-outline"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Online workers</span>
                                        <span class="info-box-number" id="activeworkers"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-red"><i class="ion ion-ios-world"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Offline workers</span>
                                        <span class="info-box-number" id="notactiveworkers"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-blue"><i class="ion ion-clock"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Online Times</span>
                                        <span class="info-box-number" id="times"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-aqua"><i class="ion ion-speedometer"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Hashrate</span>
                                        <span class="info-box-number" id="hashrate"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-green"><i class="ion ion-speedometer"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Hashrate 1h</span>
                                        <span class="info-box-number" id="hashrate1h"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-maroon"><i class="ion ion-speedometer"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Hashrate 12h</span>
                                        <span class="info-box-number" id="hashrate12h"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-green"><i class="ion ion-flag"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Shares</span>
                                        <span class="info-box-number" id="acceptedshares"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-red"><i class="ion ion-cloud"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Total hashes</span>
                                        <span class="info-box-number" id="hashes"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <span class="info-box-icon bg-blue"><i class="ion ion-waterdrop"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Effort</span>
                                        <span class="info-box-number" id="effort"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="box box-success">
                            <div class="box-header">
                                <h3 class="box-title">Online workers</h3>
                            </div>
                            <div class="box-body">
                                <table id="workerstable" class="table table-bordered table-hover table-striped"
                                       style="width: 100%"></table>
                            </div>
                        </div>
                        <div class="box box-danger">
                            <div class="box-header">
                                <h3 class="box-title">Offline workers</h3>
                            </div>
                            <div class="box-body">
                                <table id="naworkerstable" class="table table-bordered table-hover table-striped"
                                       style="width: 100%"></table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
<script src="modules/jquery/dist/jquery.min.js"></script>
<script src="modules/bootstrap/js/bootstrap.min.js"></script>
<script src="modules/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="modules/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script src="modules/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<script src="js/adminlte.min.js"></script>
<script>

    var miRefresh, wiRefresh, datatable, datatable2, workers = [], naworkers = [];

    localStorage.proxy_url = '这里填写你的xmrig-proxy的地址例如http://127.0.0.1:2222;放在服务器上就填外网地址';

    function trim(s, c) {
        if (c === "]")
            c = "\\]";
        if (c === "\\")
            c = "\\\\";
        return s.replace(new RegExp(
            "^[" + c + "]+|[" + c + "]+$", "g"
        ), "");
    }

    Object.size = function (obj) {
        var size = 0, key;
        for (key in obj) {
            if (obj.hasOwnProperty(key))
                size++;
        }
        return size;
    };

    function ajaxget(url, callback) {
        $.ajax({
            type: 'GET',
            url: url,
            success: callback,
            dataType: 'json'
        });
    }

    function formatDate(timestamp) {
        var result = 'N/A';
        if (timestamp <= 0) {
            return result;
        }
        var mistiming = (Math.round(new Date()) - timestamp) / 1000;
        if (mistiming < 1) {
            return '1 seconds ago';
        }
        var arrr = ['years', 'months', 'weeks', 'days', 'hours', 'minutes', 'seconds'];
        var arrn = [31536000, 2592000, 604800, 86400, 3600, 60, 1];
        for (var i = 6; i >= 0; i--) {
            var inm = Math.floor(mistiming / arrn[i]);
            if (inm > 0) {
                result = inm + ' ' + arrr[i] + ' ago';
            } else {
                return result;
            }
        }
        return result;
    }

    function mainInfoCallback(data) {
        if (data !== null && typeof data === 'object' && Object.size(data) > 0) {
            $('#hashrate').text(data.hashrate.total[0] + ' Kh/s');
            $('#hashrate1h').text(data.hashrate.total[2] + ' Kh/s');
            $('#hashrate12h').text(data.hashrate.total[3] + ' Kh/s');
            $('#acceptedshares').text(data.results.accepted + ' / ' + (data.results.accepted + data.results.rejected + data.results.invalid) + ' (' + Number((data.results.accepted / (data.results.accepted + data.results.rejected + data.results.invalid)) * 100).toFixed(2) + '%)');
            $('#hashes').text(data.results.hashes_total.toLocaleString());
            $('#times').text((data.uptime / 3600).toFixed(2) + ' hours');
            $('#latency').text('Ping: ' + data.results.latency + ' ms');
            $('#avg_time').text('Avg: ' + data.results.avg_time + ' s');
            $('#best').text('Best: ' + data.results.best[0].toLocaleString());
            $('#effort').text((Number((50 / data.results.avg_time) / data.hashrate.total[2]) * 100).toFixed(2) + '%');
        }
    }

    function workersInfoCallback(data) {
        if (data !== null && typeof data === 'object' && Object.size(data) > 0) {
            workers = [];
            naworkers = [];
            var aworkerscount = 0;
            var naworkerscount = 0;
            $.each(data.workers, function (i, worker) {
                var name = '';
                if (worker[0].length > 30) {
                    name = '<span data-toggle="tooltip" data-placement="top" title="' + worker[0] + '">' + worker[0].substr(0, 30) + '...</span>';
                } else {
                    name = worker[0];
                }
                var workdata = [name, worker[6].toLocaleString(), worker[10] + ' Kh/s', worker[11] + ' Kh/s', formatDate(worker[7])];
                if (parseInt(worker[2]) > 0) {
                    if (parseInt(worker[2]) > 1) {
                        workdata[0] = workdata[0] + " x" + worker[2]
                    }
                    workers.push(workdata);
                    aworkerscount++;
                } else {
                    naworkers.push(workdata);
                    naworkerscount++;
                }
            });
            $('#allworkers').text(aworkerscount + naworkerscount);
            $('#activeworkers').text(aworkerscount);
            $('#notactiveworkers').text(naworkerscount);
            fillTable();
        }
    }

    function getProxyMainInfo() {
        ajaxget(localStorage.proxy_url, mainInfoCallback);
        miRefresh = setInterval(function () {
            ajaxget(localStorage.proxy_url, mainInfoCallback);
        }, 60000);
    }

    function getProxyWorkersInfo() {
        ajaxget(localStorage.proxy_url + '/workers.json', workersInfoCallback);
        wiRefresh = setInterval(function () {
            ajaxget(localStorage.proxy_url + '/workers.json', workersInfoCallback);
        }, 60000);
    }

    function fillTable() {
        if (datatable !== null && typeof datatable === 'object') {
            datatable.clear();
            datatable.rows.add(workers);
            datatable.draw();
        }
        if (datatable2 !== null && typeof datatable2 === 'object') {
            datatable2.clear();
            datatable2.rows.add(naworkers);
            datatable2.draw();
        }
    }

    $(document).ready(function () {
        getProxyMainInfo();
        getProxyWorkersInfo();
        datatable = $('#workerstable').DataTable({
            data: workers,
            columns: [
                {title: "Name", className: 'table-center'},
                {title: "Hashes", width: '15%', className: 'table-right'},
                {title: "Hashrate 1h", width: '15%', className: 'table-right'},
                {title: "Hashrate 12h", width: '15%', className: 'table-right'},
                {title: "Last Hash", width: '15%', className: 'table-right'}
            ],
            "order": [[3, "desc"]]
        });
        datatable2 = $('#naworkerstable').DataTable({
            data: naworkers,
            columns: [
                {title: "Name", className: 'table-center'},
                {title: "Hashes", width: '15%', className: 'table-right'},
                {title: "Hashrate 1h", width: '15%', className: 'table-right'},
                {title: "Hashrate 12h", width: '15%', className: 'table-right'},
                {title: "Last Hash", width: '15%', className: 'table-right'}
            ],
            "order": [[3, "desc"]]
        });
    });
</script>
</body>
</html>


